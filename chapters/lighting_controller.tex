\chapter{Lighting Controller}
The first element of the system to be developed once the project began was the lighting controller.
This part of the project was built from scratch, as there was no prior work that had been done in this area.
This made it perfect for the first half of the year,
as other sections of the project required hardware that was currently being developed by the students finishing mid-year.

The lighting controller has a simple function in this system; it maps processed biosignals to lighting position and intensity.
Therefore, it should be able to communicate with the off-body PC and pass various commands through to whatever lights are connect to it.

Different protocols for controlling various lighting fixtures exist.
To determine which should be used for this project, a decision matrix, shown in~\autoref{tab:decision} and~\autoref{tab:decision_cont} was used.
For this project, DMX512 (DMX) was determined to be the most appropriate.

\begin{table}[!ht]
    \caption{Lighting protocol decision matrix}\label{tab:decision}
    \centering
    \input{chapters/project_plan/tables/lighting.tex}
\end{table}

\begin{table}[!ht]
    \caption{Lighting protocol decision matrix (continued)}\label{tab:decision_cont}
    \centering
    \input{chapters/project_plan/tables/lighting_continued.tex}
\end{table}

% TODO: ADD PURCHASED VS DIY CONTROLLER DECISION MATRIX
To control DMX fixtures, there are two options, using an off-the-shelf controller or creating a custom controller.
As shown in this decision matrix, the more viable option was to purchase an off-the-shelf controller.

\section{Prototyping Fixture}
To aid in the development of the lighting controller, a prototyping fixture was developed.
This fixture just requires an Arduino and a NeoPixel LED strip to function.
This has the major benefit over a real fixture of being extremely cost effective, as well as being small, and powered over USB.

The prototyping fixture is made up of 8 NeoPixel LEDs with 4 DMX channels each.
The DMX channels are intensity, red channel, green channel, blue channel.
This makes a total of 32 channels (\(4 \times 8\)) for the 8 LEDs.

\subsection{DMX}
The fixture connects to the off-body PC over USB and communicates via serial.
While the device does not strictly require DMX frames in order to function,
DMX was still implemented in software in order to better understand the protocol as well as unify the protoyping fixture with the real controller.


Receives DMX frames using interrupts
and stores them into array for processing.
DMX frames are 512 bytes wide.
A frame consists of the entire DMX `universe' of channels.
Individual channels are never written,
instead the entire `universe' is updated with each frame.
Updates happen continually at a known rate.
This way, fixture are aware if they lose connection to the controller,
since they stop receiving frames.

\subsection{NeoPixels}
LEDs controlled using NeoPixel library~\cite{NeoPixel}.
LEDs can be colored independently using red, green, and blue values.
Each color is represented using a byte.

\subsection{Integration}
Both the DMX channel and color values are represented using bytes.
No additional scaling is required.

Brightness needs to be mapped using
\begin{lstlisting}[language=C]
  (intensity * color) >> 8;
\end{lstlisting}

In this case bit shifting by 8 is equivalent to dividing by 255.
This means that at maximum intensity the result of this calculation is the color value.
While at the minimum intensity the calculation becomes 0.

The values are sent over serial using Base64.
This is so that the carrige return line can be used to mark the end of the incoming values.
This was because the Arduino could become out of sync with what was being sent.
If this happened there is no way of getting back in sync,
because any special character could be interpreted as a regular value.
This is why Base64 is necessary, because it allows for special characters that are seperate
from the designated regular character set.
The values are sent as single decimal digits.
So when they are received they must be decoded back into bytes.

The value of each LED is then encoded across 4 bytes.
So the main program loops, incrementing by 4 each time,
and extracts the discrete bytes, setting the base address of the LED to the derived color.
Once this is done for all the LEDs, they are updated using the show() function.

\section{OpenDMX Controller}
When using expensive hardware in professional settings, it is important to use compliant hardware.
While the prototyping fixture could be used for system verification,
it was decided that existing hardware would be purchased for lighting control.
\textbf{DECISION MATRIX HERE (MIGHT ALREADY HAVE ONE IN MY RESULTS POWER POINT?)}

\subsection{Interface}
The driver provided by the manufacturer was written in C\#.
Existing code for the project is written in MATLAB.
We needed some way of controlling the device from MATLAB to utilise previous code.
\textbf{MORE TO BE WRITTEN ABOUT THIS}
